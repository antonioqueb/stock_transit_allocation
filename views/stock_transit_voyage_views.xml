<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- SEARCH VIEW -->
    <record id="view_transit_voyage_search" model="ir.ui.view">
        <field name="name">stock.transit.voyage.search</field>
        <field name="model">stock.transit.voyage</field>
        <field name="arch" type="xml">
            <search string="Buscar Viaje">
                <field name="container_number"/>
                <field name="vessel_name"/>
                <field name="bl_number"/>
                <filter string="En Tr치nsito" name="in_transit" domain="[('state', '=', 'in_transit')]"/>
                <filter string="En Puerto" name="at_port" domain="[('state', '=', 'at_port')]"/>
                <group expand="0" string="Agrupar Por">
                    <filter string="Estado" name="group_by_state" context="{'group_by': 'state'}"/>
                    <filter string="ETA" name="group_by_eta" context="{'group_by': 'eta'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- LIST VIEW (Odoo 19 usa <list> en lugar de <tree>) -->
    <record id="view_transit_voyage_list" model="ir.ui.view">
        <field name="name">stock.transit.voyage.list</field>
        <field name="model">stock.transit.voyage</field>
        <field name="arch" type="xml">
            <list decoration-info="state == 'in_transit'" decoration-success="state == 'arrived'">
                <field name="name"/>
                <field name="container_number"/>
                <field name="vessel_name"/>
                <field name="eta" widget="remaining_days"/>
                <field name="total_m2" sum="Total"/>
                <field name="allocation_percent" widget="progressbar"/>
                <field name="state" widget="badge" decoration-info="state == 'in_transit'" decoration-warning="state == 'at_port'"/>
            </list>
        </field>
    </record>

    <!-- KANBAN VIEW -->
    <record id="view_transit_voyage_kanban" model="ir.ui.view">
        <field name="name">stock.transit.voyage.kanban</field>
        <field name="model">stock.transit.voyage</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_small_column" quick_create="false">
                <field name="state"/>
                <field name="name"/>
                <field name="container_number"/>
                <field name="vessel_name"/>
                <field name="transit_progress"/>
                <field name="allocation_percent"/>
                <field name="eta"/>
                <field name="activity_ids"/>
                <templates>
                    <t t-name="card">
                        <div class="d-flex justify-content-between">
                            <strong class="o_kanban_record_title"><field name="container_number"/></strong>
                            <span class="badge rounded-pill text-bg-light"><field name="name"/></span>
                        </div>
                        <div class="mt-2 text-muted">
                            <i class="fa fa-ship me-1"></i> <field name="vessel_name"/>
                        </div>
                        
                        <!-- Widget de Progreso Visual -->
                        <div class="mt-2">
                            <field name="transit_progress" widget="transit_ship_progress"/>
                        </div>

                        <div class="mt-3">
                            <label class="small text-muted">Asignaci칩n:</label>
                            <field name="allocation_percent" widget="progressbar"/>
                        </div>
                        <div class="mt-2 d-flex justify-content-between align-items-center">
                            <span class="small text-primary"><field name="eta"/></span>
                            <field name="activity_ids" widget="kanban_activity"/>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- FORM VIEW -->
    <record id="view_transit_voyage_form" model="ir.ui.view">
        <field name="name">stock.transit.voyage.form</field>
        <field name="model">stock.transit.voyage</field>
        <field name="arch" type="xml">
            <form string="Gesti칩n de Tr치nsito">
                <header>
                    <button name="action_load_from_picking" string="游닌 Cargar desde BL (Picking)" type="object" class="btn-secondary" invisible="state != 'draft'"/>
                    <button name="action_confirm_transit" string="游뚹 Confirmar Zarpe" type="object" class="btn-primary" invisible="state != 'draft'"/>
                    <button name="action_arrive" string="游끠 Registrar Llegada" type="object" class="btn-success" invisible="state != 'in_transit'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,in_transit,at_port,arrived"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name"/>
                        </h1>
                        <h3>
                            <field name="container_number" placeholder="N칰mero de Contenedor"/>
                        </h3>
                    </div>
                    <group>
                        <group string="Detalles de Log칤stica">
                            <field name="vessel_name"/>
                            <field name="voyage_number"/>
                            <field name="bl_number"/>
                            <field name="picking_id" readonly="state != 'draft'"/>
                        </group>
                        <group string="Itinerario">
                            <field name="etd"/>
                            <field name="eta"/>
                            <field name="arrival_date" readonly="1"/>
                            <field name="transit_progress" widget="transit_ship_progress"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Asignaci칩n de Lotes (Torre de Control)" name="lots">
                            <!-- CORRECCI칍N: La lista debe estar dentro del campo line_ids -->
                            <field name="line_ids">
                                <list name="transit_lines_list" create="0" delete="0" decoration-success="allocation_status == 'reserved'">
                                    <field name="product_id"/>
                                    <field name="lot_id"/>
                                    <field name="x_grosor"/>
                                    <field name="x_alto"/>
                                    <field name="x_ancho"/>
                                    <field name="product_uom_qty" string="m"/>
                                    <field name="partner_id" widget="many2one_avatar"/>
                                    <field name="allocation_status" widget="badge" decoration-success="allocation_status == 'reserved'" decoration-info="allocation_status == 'available'"/>
                                    <button name="action_reassign_wizard" string="游댃 Reasignar" type="object" class="btn-link"/>
                                </list>
                            </field>
                        </page>
                        <page string="Estad칤sticas">
                            <group>
                                <field name="total_m2"/>
                                <field name="allocated_m2"/>
                                <field name="allocation_percent" widget="progressbar"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- ACTION -->
    <record id="action_transit_voyage" model="ir.actions.act_window">
        <field name="name">Torre de Control (Tr치nsito)</field>
        <field name="res_model">stock.transit.voyage</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Registre su primer Contenedor en Tr치nsito
            </p>
            <p>
                Importe el BL primero en Recepciones, luego vinc칰lelo aqu칤 para gestionar las asignaciones.
            </p>
        </field>
    </record>

    <menuitem id="menu_transit_control_tower"
              name="Torre de Control (Tr치nsito)"
              parent="stock.menu_stock_root"
              sequence="2"
              action="action_transit_voyage"/>

</odoo>