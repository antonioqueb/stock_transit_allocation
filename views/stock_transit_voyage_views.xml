<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================================== -->
    <!-- VISTAS DEL MODELO STOCK.TRANSIT.VOYAGE (VIAJES)           -->
    <!-- ========================================================== -->
    
    <!-- 1. VISTA DE LISTA (VIAJES / CONTENEDORES) -->
    <record id="view_stock_transit_voyage_list" model="ir.ui.view">
        <field name="name">stock.transit.voyage.list</field>
        <field name="model">stock.transit.voyage</field>
        <field name="arch" type="xml">
            <!-- Decoraciones basadas en custom_status -->
            <list decoration-info="custom_status == 'on_sea'" 
                  decoration-success="custom_status == 'delivered'" 
                  decoration-warning="custom_status in ['solicitud', 'production']">
                <field name="name"/>
                <field name="purchase_id" string="OC Origen"/>
                <field name="custom_status" widget="badge" 
                       decoration-warning="custom_status in ['solicitud', 'production']" 
                       decoration-info="custom_status in ['booking', 'on_sea']"
                       decoration-primary="custom_status == 'puerto_origen'"
                       decoration-success="custom_status == 'delivered'"/>
                <field name="container_number" string="Contenedores"/>
                <field name="bl_number"/>
                <field name="shipping_line"/>
                <field name="eta" widget="remaining_days" optional="show"/>
                <field name="allocation_percent" widget="progressbar" string="% Asig."/>
            </list>
        </field>
    </record>

    <!-- 2. VISTA DE FORMULARIO (VIAJES) -->
    <record id="view_stock_transit_voyage_form" model="ir.ui.view">
        <field name="name">stock.transit.voyage.form</field>
        <field name="model">stock.transit.voyage</field>
        <field name="arch" type="xml">
            <form string="Gesti칩n de Tr치nsito">
                <header>
                    <!-- Botones controlados por custom_status -->
                    <button name="action_load_from_purchase" string="游댃 Cargar desde OC" type="object" 
                            class="btn-info" 
                            invisible="picking_id != False or custom_status == 'delivered'"/>
                    
                    <button name="action_load_from_picking" string="游뚹 Sincronizar Lotes (Picking)" type="object" 
                            class="btn-secondary" 
                            invisible="picking_id == False or custom_status == 'delivered'"/>
                    
                    <button name="action_confirm_transit" string="游뚹 Confirmar Zarpe" type="object" 
                            class="btn-primary" 
                            invisible="custom_status not in ['solicitud', 'production', 'booking', 'puerto_origen']"/>
                    
                    <button name="action_arrive" string="游끠 Registrar Llegada" type="object" 
                            class="btn-success" 
                            invisible="custom_status != 'on_sea' and custom_status != 'puerto_destino'"/>

                    <button name="action_cancel" string="Cancelar" type="object"
                            invisible="custom_status == 'delivered'"/>
                            
                    <!-- Statusbar unificado a custom_status -->
                    <field name="custom_status" widget="statusbar" statusbar_visible="solicitud,production,on_sea,delivered"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <span class="o_form_label">Referencia de Viaje</span>
                        <h1><field name="name"/></h1>
                        <label for="container_number" string="Contenedor Actual"/>
                        <h3><field name="container_number" placeholder="Ej. MSKU1234567 / TBD"/></h3>
                    </div>
                    <group>
                        <group string="Log칤stica y Estatus">
                            <field name="purchase_id" readonly="1" invisible="not purchase_id"/>
                            <field name="picking_id" readonly="1" invisible="not picking_id"/>
                            <field name="shipping_line" placeholder="Ej. MSC / Maersk"/>
                            <field name="vessel_name"/>
                            <field name="bl_number" string="Folio / BL"/>
                        </group>
                        <group string="Itinerario">
                            <field name="transit_days_expected"/>
                            <field name="etd"/>
                            <field name="eta"/>
                            <field name="arrival_date" readonly="1" invisible="not arrival_date"/>
                            <field name="transit_progress" widget="transit_ship_progress"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Contenido y Asignaci칩n" name="lots">
                            <field name="line_ids">
                                <list create="0" delete="0" decoration-success="allocation_status == 'reserved'" 
                                      decoration-muted="not lot_id" editable="bottom">
                                    <field name="container_number" optional="show"/> 
                                    <field name="product_id" readonly="1"/>
                                    <field name="lot_id" placeholder="Esperando recepci칩n..." decoration-bf="1"/>
                                    <field name="product_uom_qty" string="m" sum="Total m"/>
                                    <field name="partner_id" widget="many2one_avatar"/>
                                    <field name="order_id" optional="show" widget="badge"/>
                                    <field name="allocation_status" widget="badge" 
                                           decoration-success="allocation_status == 'reserved'"
                                           decoration-info="allocation_status == 'available'"/>
                                    <button name="action_reassign_wizard" string="Reasignar" type="object" icon="fa-retweet" class="btn-link"/>
                                    <field name="notes" optional="hide"/>
                                </list>
                            </field>
                        </page>
                        <page string="M칠tricas de Carga">
                            <group>
                                <group>
                                    <field name="total_m2"/>
                                    <field name="allocated_m2"/>
                                </group>
                                <group>
                                    <field name="allocation_percent" widget="progressbar"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- 3. VISTA KANBAN ACTUALIZADA -->
    <record id="view_stock_transit_voyage_kanban" model="ir.ui.view">
        <field name="name">stock.transit.voyage.kanban</field>
        <field name="model">stock.transit.voyage</field>
        <field name="arch" type="xml">
            <!-- Agrupaci칩n principal por custom_status -->
            <kanban default_group_by="custom_status" class="o_kanban_small_column" records_draggable="0" sample="1">
                <field name="custom_status"/>
                <field name="name"/>
                <field name="vessel_name"/>
                <field name="shipping_line"/>
                <field name="container_number"/>
                <field name="eta"/>
                <field name="allocation_percent"/>
                <field name="transit_progress"/> 
                <templates>
                    <t t-name="card">
                        <div class="d-flex flex-column">
                            <div class="d-flex justify-content-between mb-2">
                                <strong class="o_kanban_record_title text-primary">
                                    <field name="name"/>
                                </strong>
                                <field name="custom_status" widget="label_selection" 
                                       options="{'classes': {'solicitud': 'warning', 'production': 'warning', 'on_sea': 'info', 'delivered': 'success'}}"/>
                            </div>
                            <div class="text-muted mb-1">
                                <i class="fa fa-shopping-cart me-1"/> <field name="purchase_id"/>
                            </div>
                            <div class="text-muted mb-1" invisible="not shipping_line">
                                <small><field name="shipping_line"/></small>
                            </div>
                            <div class="text-muted mb-1" invisible="not vessel_name">
                                <i class="fa fa-ship me-1"/> <field name="vessel_name"/>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-auto">
                                <span class="text-muted small">
                                    ETA: <field name="eta" widget="remaining_days"/>
                                </span>
                            </div>
                            <div class="mt-2">
                                <field name="allocation_percent" widget="progressbar"/>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ========================================================== -->
    <!-- NUEVA VISTA: S츼BANA DE SEGUIMIENTO (AGRUPADO)             -->
    <!-- ========================================================== -->

    <record id="view_transit_sheet_list" model="ir.ui.view">
        <field name="name">stock.transit.sheet.list</field>
        <field name="model">stock.transit.sheet</field>
        <field name="arch" type="xml">
            <list string="S치bana de Seguimiento" create="0" delete="0" edit="0"
                  decoration-success="voyage_status == 'delivered'"
                  decoration-info="voyage_status in ['on_sea', 'booking']"
                  decoration-warning="voyage_status in ['solicitud', 'production']">
                
                <field name="purchase_id" string="OC Sistema"/>
                <field name="date_order" string="Fecha OC" widget="date"/>
                <field name="voyage_status" widget="badge" 
                       decoration-warning="voyage_status in ['solicitud', 'production']" 
                       decoration-info="voyage_status in ['on_sea', 'booking']"
                       decoration-success="voyage_status == 'delivered'"/>
                <field name="salesperson_id" widget="many2one_avatar_user"/>
                <field name="order_id" string="Sales Order"/>
                <field name="partner_id" string="Cliente / Proyecto"/>
                <field name="proforma_ref" string="Proforma"/>
                <field name="vendor_id" string="Proveedor"/>
                <field name="product_id" string="Descripci칩n"/>
                <field name="product_uom_qty" string="M2 Embarcados" sum="Total"/>
                <field name="container_number"/>
                <field name="shipping_line" optional="hide"/>
                <field name="bl_number" optional="show"/>
                <field name="etd" widget="date"/>
                <field name="eta" widget="date"/>
                <field name="arrival_date" widget="date" optional="show"/>
            </list>
        </field>
    </record>

    <!-- ACCIONES -->
    <record id="action_transit_tracking_sheet" model="ir.actions.act_window">
        <field name="name">S치bana de Seguimiento</field>
        <field name="res_model" >stock.transit.sheet</field>
        <field name="view_mode">list</field>
        <field name="view_id" ref="view_transit_sheet_list"/>
    </record>

    <record id="action_stock_transit_voyage_main" model="ir.actions.act_window">
        <field name="name">Viajes y Contenedores</field>
        <field name="res_model">stock.transit.voyage</field>
        <field name="view_mode">kanban,list,form</field>
    </record>

    <!-- MEN칔S -->
    <menuitem id="menu_transit_root" name="Torre de Control" 
              web_icon="stock_transit_allocation,static/description/icon.png" sequence="10"/>

    <menuitem id="menu_transit_sheet" name="S치bana de Seguimiento" 
              parent="menu_transit_root" action="action_transit_tracking_sheet" sequence="1"/>

    <menuitem id="menu_transit_voyage_dashboard" name="Viajes y Contenedores" 
              parent="menu_transit_root" action="action_stock_transit_voyage_main" sequence="2"/>
</odoo>